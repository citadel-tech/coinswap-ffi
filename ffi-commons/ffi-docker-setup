#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
COINSWAP_REPO="https://github.com/citadel-tech/coinswap.git"
COINSWAP_DIR="$SCRIPT_DIR/.coinswap-docker-stack"
IMAGE_NAME="coinswap"
BITCOIN_IMAGE_NAME="bitcoin-mutinynet"
VERSION_FILE="latest"

BITCOIN_DATADIR="/home/coinswap/.bitcoin"
BITCOIN_NETWORK="regtest"
BITCOIN_RPC_PORT="18442"
BITCOIN_ZMQ_PORT="28332"
MAKERD1_PORT="6102"
MAKERD1_RPC_PORT="6103"
MAKERD2_PORT="16102"
MAKERD2_RPC_PORT="16103"
MAKERD3_PORT="26102"
MAKERD3_RPC_PORT="26103"
MAKERD4_PORT="36102"
MAKERD4_RPC_PORT="36103"
TOR_SOCKS_PORT="9050"
TOR_CONTROL_PORT="9051"
NUM_MAKERS="2"
USE_TAPROOT="false"
RUN_ALL="false"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed. Please install Docker first."
        exit 1
    fi
    
    if ! docker info &> /dev/null; then
        print_error "Docker is not running. Please start Docker first."
        exit 1
    fi
}

setup_coinswap_repo() {
    if [ ! -d "$COINSWAP_DIR" ]; then
        print_info "Cloning coinswap repository for Docker images..."
        git clone --depth 1 "$COINSWAP_REPO" "$COINSWAP_DIR"
    else
        print_info "Coinswap repository already exists at $COINSWAP_DIR"
    fi
}

generate_torrc() {
    local torrc_file="$SCRIPT_DIR/torrc.generated"
    print_info "Generating torrc configuration..."
    cat > "$torrc_file" << EOF
SocksPort 0.0.0.0:${TOR_SOCKS_PORT}
ControlPort 0.0.0.0:${TOR_CONTROL_PORT}
HashedControlPassword 16:16E946B27E1A526E60A2B64061EC3F140ACA991F1B705ACD35374D6730
DataDirectory /var/lib/tor
EOF
    print_success "Generated torrc: $torrc_file"
}

generate_maker_service() {
    local maker_num="$1"
    local maker_port="$2"
    local maker_rpc_port="$3"
    local data_volume="$4"
    local wallet_name="$5"
    local sleep_time="${6:-5}"

    local taproot_flag=""
    if [[ "$USE_TAPROOT" == "true" ]]; then
        taproot_flag=" --taproot"
    fi

    cat << EOF
  ${wallet_name}:
    image: coinswap/${IMAGE_NAME}:master
    container_name: coinswap-${wallet_name}
    network_mode: "service:tor"
    command:
      - sh
      - -c
      - |
        sleep ${sleep_time}
        mkdir -p /home/coinswap/.coinswap/maker

        RAND_SUFFIX=\$\$(date +%s)
        WALLET_NAME="${wallet_name}-wallet-\$\$RAND_SUFFIX"

        echo "Wallet Name: \$\$WALLET_NAME"

        printf '%s\n' \\
          "network_port = ${maker_port}" \\
          "rpc_port = ${maker_rpc_port}" \\
          "socks_port = ${TOR_SOCKS_PORT}" \\
          "control_port = ${TOR_CONTROL_PORT}" \\
          "tor_auth_password = ${TOR_AUTH_PASSWORD:-coinswap}" \\
          "min_swap_amount = 10000" \\
          "fidelity_amount = 50000" \\
          "fidelity_timelock = 13104" \\
          "connection_type = TOR" \\
          "base_fee = 100" \\
          "amount_relative_fee_ppt = 1000" \\
          > /home/coinswap/.coinswap/maker/config.toml
        makerd -r bitcoind:${BITCOIN_RPC_PORT} -a user:password -w "\$\$WALLET_NAME"${taproot_flag}
    volumes:
      - ${data_volume}:/home/coinswap/.coinswap
    environment:
      - RUST_LOG=info
      - TOR_SOCKS_PORT=${TOR_SOCKS_PORT}
      - TOR_CONTROL_PORT=${TOR_CONTROL_PORT}
      - TOR_AUTH_PASSWORD=${TOR_AUTH_PASSWORD:-coinswap}
      - MIN_SWAP_AMOUNT=10000
      - FIDELITY_AMOUNT=50000
      - FIDELITY_TIMELOCK=13104
      - BASE_FEE=100
      - AMOUNT_RELATIVE_FEE_PPT=1000
    restart: unless-stopped

EOF
}

generate_compose_file() {
    local compose_file="$SCRIPT_DIR/docker-compose.generated.yml"

    generate_torrc

    local bitcoin_tag="latest"
    if [ -f "$VERSION_FILE" ]; then
        bitcoin_tag=$(grep "^TAG=" "$VERSION_FILE" | cut -d'=' -f2)
    fi

    print_info "Generating docker-compose configuration..."

    cat > "$compose_file" << EOF
services:
  bitcoind:
    image: coinswap/${BITCOIN_IMAGE_NAME}:${bitcoin_tag}
    container_name: coinswap-bitcoind
    user: "0:0"
    command: bitcoind -datadir=/home/bitcoin/.bitcoin -server=1 -rpcuser=user -rpcpassword=password -rpcallowip=0.0.0.0/0 -txindex=1 -blockfilterindex=1 -regtest=1 -fallbackfee=0.00001000 -rpcbind=0.0.0.0 -rpcport=${BITCOIN_RPC_PORT} -zmqpubrawblock=tcp://0.0.0.0:${BITCOIN_ZMQ_PORT} -zmqpubrawtx=tcp://0.0.0.0:${BITCOIN_ZMQ_PORT}
    ports:
      - "${BITCOIN_RPC_PORT}:${BITCOIN_RPC_PORT}"
      - "${BITCOIN_ZMQ_PORT}:${BITCOIN_ZMQ_PORT}"
    volumes:
      - bitcoin-data:/home/bitcoin/.bitcoin
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-rpcuser=user", "-rpcpassword=password", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5

  tor:
    image: osminogin/tor-simple
    container_name: coinswap-tor
    volumes:
      - tor-data:/var/lib/tor
      - ./torrc.generated:/etc/tor/torrc:ro
    ports:
      - "${TOR_SOCKS_PORT}:${TOR_SOCKS_PORT}"
      - "${TOR_CONTROL_PORT}:${TOR_CONTROL_PORT}"
      - "${MAKERD1_RPC_PORT}:${MAKERD1_RPC_PORT}"
      - "${MAKERD2_RPC_PORT}:${MAKERD2_RPC_PORT}"
      - "${MAKERD3_RPC_PORT}:${MAKERD3_RPC_PORT}"
      - "${MAKERD4_RPC_PORT}:${MAKERD4_RPC_PORT}"
    restart: unless-stopped

EOF

    # Generate makers based on --run-all or standard/taproot mode
    if [[ "$RUN_ALL" == "true" ]]; then
        print_info "Generating 4 makers (2 standard + 2 taproot)..."
        # Standard makers
        USE_TAPROOT="false"
        generate_maker_service "1" "$MAKERD1_PORT" "$MAKERD1_RPC_PORT" "maker1-data" "makerd1" >> "$compose_file"
        generate_maker_service "2" "$MAKERD2_PORT" "$MAKERD2_RPC_PORT" "maker2-data" "makerd2" >> "$compose_file"
        # Taproot makers
        USE_TAPROOT="true"
        generate_maker_service "3" "$MAKERD3_PORT" "$MAKERD3_RPC_PORT" "maker3-data" "makerd3" >> "$compose_file"
        generate_maker_service "4" "$MAKERD4_PORT" "$MAKERD4_RPC_PORT" "maker4-data" "makerd4" >> "$compose_file"
    else
        # Standard 2 makers (either standard or taproot)
        generate_maker_service "1" "$MAKERD1_PORT" "$MAKERD1_RPC_PORT" "maker1-data" "makerd1" >> "$compose_file"
        generate_maker_service "2" "$MAKERD2_PORT" "$MAKERD2_RPC_PORT" "maker2-data" "makerd2" >> "$compose_file"
    fi

    cat >> "$compose_file" << EOF

volumes:
  bitcoin-data:
    driver: local
  tor-data:
    driver: local
  maker1-data:
    driver: local
  maker2-data:
    driver: local
  maker3-data:
    driver: local
  maker4-data:
    driver: local

networks:
  default:
    name: coinswap-network
EOF

    print_success "Generated docker-compose configuration: $compose_file"
}

build_image() {
    print_info "Building Coinswap Docker image..."
    cd "$COINSWAP_DIR"
    if docker build -f docker/Dockerfile -t "coinswap/${IMAGE_NAME}:master" -t "coinswap/${IMAGE_NAME}:latest" .; then
        print_success "Coinswap image built successfully"
    else
        print_error "Failed to build Coinswap image"
        exit 1
    fi
}

build_bitcoin_image() {
    print_info "Building Bitcoin Mutinynet Docker image..."
    cd "$COINSWAP_DIR"
    if [ -f "docker/bitcoin-mutinynet.version" ]; then
        local tag=$(grep "^TAG=" "docker/bitcoin-mutinynet.version" | cut -d'=' -f2)
        local f_amd64=$(grep "^FILENAME_AMD64=" "docker/bitcoin-mutinynet.version" | cut -d'=' -f2)
        local s_amd64=$(grep "^SHA256_AMD64=" "docker/bitcoin-mutinynet.version" | cut -d'=' -f2)
        local f_arm64=$(grep "^FILENAME_ARM64=" "docker/bitcoin-mutinynet.version" | cut -d'=' -f2)
        local s_arm64=$(grep "^SHA256_ARM64=" "docker/bitcoin-mutinynet.version" | cut -d'=' -f2)

        if docker build \
            --build-arg TAG="$tag" \
            --build-arg FILENAME_AMD64="$f_amd64" \
            --build-arg SHA256_AMD64="$s_amd64" \
            --build-arg FILENAME_ARM64="$f_arm64" \
            --build-arg SHA256_ARM64="$s_arm64" \
            -f docker/Dockerfile.bitcoin-mutinynet \
            -t "coinswap/${BITCOIN_IMAGE_NAME}:${tag}" \
            -t "coinswap/${BITCOIN_IMAGE_NAME}:latest" .; then
            print_success "Bitcoin Mutinynet image built successfully"
        else
            print_error "Failed to build Bitcoin Mutinynet image"
            exit 1
        fi
    else
        print_error "Version file not found: docker/bitcoin-mutinynet.version"
        exit 1
    fi
}

start_stack() {
    check_docker
    generate_compose_file
    print_info "Starting Coinswap stack..."
    cd "$SCRIPT_DIR"
    if docker compose -f docker-compose.generated.yml up -d; then
        print_success "Coinswap stack started successfully"
        docker compose -f docker-compose.generated.yml ps
        
        # Wait 10 seconds for services to initialize
        print_info "Waiting 10 seconds for services to initialize..."
        sleep 10
        
        # Automatically fund makers
        fund_makers
        
        # Start background block mining
        start_block_mining
    else
        print_error "Failed to start Coinswap stack"
        exit 1
    fi
}

stop_stack() {
    print_info "Stopping Coinswap stack..."
    cd "$SCRIPT_DIR"
    
    # Stop block mining if running
    stop_block_mining
    
    if [ -f "docker-compose.generated.yml" ]; then
        # Clean up wallet directories in containers before stopping them
        print_info "Cleaning wallet directories in containers..."
        docker exec coinswap-bitcoind sh -c "rm -rf /home/*" 2>/dev/null || true
        docker exec coinswap-makerd1 sh -c "rm -rf /home/coinswap/.coinswap/*" 2>/dev/null || true
        docker exec coinswap-makerd2 sh -c "rm -rf /home/coinswap/.coinswap/*" 2>/dev/null || true
        
        docker compose -f docker-compose.generated.yml down
    fi
    print_success "Coinswap stack stopped and cleaned up"
}

show_logs() {
    cd "$SCRIPT_DIR"
    local compose_file="docker-compose.generated.yml"
    if [ -n "$1" ]; then
        docker compose -f "$compose_file" logs -f "$1"
    else
        docker compose -f "$compose_file" logs -f
    fi
}

fund_makers() {
    print_info "Funding makers with Bitcoin (regtest)..."

    print_info "Creating Bitcoin wallet..."
    docker exec coinswap-bitcoind bitcoin-cli -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password createwallet "test" 2>/dev/null || true

    print_info "Mining initial blocks for coinbase maturity..."
    local addr=$(docker exec coinswap-bitcoind bitcoin-cli -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password -rpcwallet=test getnewaddress)
    docker exec coinswap-bitcoind bitcoin-cli -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password generatetoaddress 101 "$addr"

    print_info "Waiting for makers to start..."
    sleep 15

    print_info "Funding makerd1..."
    local maker1_addr=$(docker logs coinswap-makerd1 2>&1 | grep "Send at least" | tail -1 | grep -oP 'bcrt1[a-zA-Z0-9]+')
    if [ -n "$maker1_addr" ]; then
        print_info "Makerd1 address: $maker1_addr"
        docker exec coinswap-bitcoind bitcoin-cli -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password -rpcwallet=test sendtoaddress "$maker1_addr" 1.0
        print_success "Sent 1 BTC to makerd1"
    else
        print_warning "Could not find makerd1 address."
    fi

    print_info "Funding makerd2..."
    local maker2_addr=$(docker logs coinswap-makerd2 2>&1 | grep "Send at least" | tail -1 | grep -oP 'bcrt1[a-zA-Z0-9]+')
    if [ -n "$maker2_addr" ]; then
        print_info "Makerd2 address: $maker2_addr"
        docker exec coinswap-bitcoind bitcoin-cli -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password -rpcwallet=test sendtoaddress "$maker2_addr" 1.0
        print_success "Sent 1 BTC to makerd2"
    else
        print_warning "Could not find makerd2 address."
    fi

    # Only fund maker3 and maker4 if running in --run-all mode
    if [[ "$RUN_ALL" == "true" ]]; then
        print_info "Funding makerd3..."
        local maker3_addr=$(docker logs coinswap-makerd3 2>&1 | grep "Send at least" | tail -1 | grep -oP 'bcrt1[a-zA-Z0-9]+')
        if [ -n "$maker3_addr" ]; then
            print_info "Makerd3 address: $maker3_addr"
            docker exec coinswap-bitcoind bitcoin-cli -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password -rpcwallet=test sendtoaddress "$maker3_addr" 1.0
            print_success "Sent 1 BTC to makerd3"
        else
            print_warning "Could not find makerd3 address."
        fi

        print_info "Funding makerd4..."
        local maker4_addr=$(docker logs coinswap-makerd4 2>&1 | grep "Send at least" | tail -1 | grep -oP 'bcrt1[a-zA-Z0-9]+')
        if [ -n "$maker4_addr" ]; then
            print_info "Makerd4 address: $maker4_addr"
            docker exec coinswap-bitcoind bitcoin-cli -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password -rpcwallet=test sendtoaddress "$maker4_addr" 1.0
            print_success "Sent 1 BTC to makerd4"
        else
            print_warning "Could not find makerd4 address."
        fi
    fi

    print_success "Makers funded successfully!"
    echo ""
    echo "Maker wallets:"
    echo "  Makerd1: 1 BTC (port 6103)"
    echo "  Makerd2: 1 BTC (port 16103)"
    if [[ "$RUN_ALL" == "true" ]]; then
        echo "  Makerd3: 1 BTC (port 26103)"
        echo "  Makerd4: 1 BTC (port 36103)"
    fi
}

mine_blocks() {
    local addr=$(docker exec coinswap-bitcoind bitcoin-cli \
        -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password \
        -rpcwallet=test getnewaddress 2>/dev/null)
    
    docker exec coinswap-bitcoind bitcoin-cli \
        -regtest -rpcport=$BITCOIN_RPC_PORT -rpcuser=user -rpcpassword=password \
        generatetoaddress 1 "$addr" > /dev/null 2>&1
}

start_block_mining() {
    local pidfile="$SCRIPT_DIR/.block-mining.pid"
    
    if [ -f "$pidfile" ]; then
        local pid=$(cat "$pidfile")
        if ps -p "$pid" > /dev/null 2>&1; then
            print_warning "Block mining already running (PID: $pid)"
            return 0
        fi
    fi
    
    print_info "Starting automatic block mining (every 3 seconds)..."
    
    (
        while true; do
            if ! docker ps --format '{{.Names}}' | grep -q "coinswap-bitcoind"; then
                break
            fi
            mine_blocks
            sleep 3
        done
    ) &
    
    local mining_pid=$!
    echo "$mining_pid" > "$pidfile"
    print_success "Block mining started (PID: $mining_pid)"
}

stop_block_mining() {
    local pidfile="$SCRIPT_DIR/.block-mining.pid"
    
    if [ -f "$pidfile" ]; then
        local pid=$(cat "$pidfile")
        if ps -p "$pid" > /dev/null 2>&1; then
            print_info "Stopping block mining (PID: $pid)..."
            kill "$pid" 2>/dev/null || true
            # Wait a bit and force kill if needed
            sleep 1
            kill -9 "$pid" 2>/dev/null || true
            print_success "Block mining stopped"
        fi
        rm -f "$pidfile"
    fi
}

show_help() {
    echo "Coinswap Docker Setup Script (regtest, fixed config)"
    echo ""
    echo "Usage: $0 [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo "  setup               Setup environment (clone repo, build images)"
    echo "  build               Build the Coinswap Docker image"
    echo "  build-bitcoin       Build the Bitcoin Mutinynet Docker image"
    echo "  start               Start the full stack (auto-funds makers, auto-mines blocks)"
    echo "  stop                Stop the Coinswap stack and block mining"
    echo "  restart             Restart the Coinswap stack"
    echo "  fund-makers         Manually fund maker wallets (done automatically on start)"
    echo "  mine [N]            Manually mine N blocks (auto-mining runs every 3s)"
    echo "  start-mining        Start automatic block mining"
    echo "  stop-mining         Stop automatic block mining"
    echo "  logs [service]      Show logs (bitcoind, tor, makerd1, makerd2)"
    echo "  status              Show status of running services"
    echo ""
    echo "Options:"
    echo "  --taproot           Enable Taproot protocol for makers (default: disabled)"
    echo "  --run-all           Run all 4 makers (2 standard + 2 taproot)"
    echo ""
    echo "Examples:"
    echo "  $0 setup            # First time setup"
    echo "  $0 start            # Starts stack with 2 standard makers"
    echo "  $0 start --taproot  # Start with 2 Taproot makers"
    echo "  $0 start --run-all  # Start with 4 makers (2 standard + 2 taproot)"
    echo "  $0 mine 10          # Manually mine 10 blocks"
    echo "  $0 logs makerd1     # View makerd1 logs"
}

# Parse command-line arguments
COMMAND="${1:-}"
shift || true

while [[ $# -gt 0 ]]; do
    case "$1" in
        --taproot)
            USE_TAPROOT="true"
            print_info "Taproot protocol enabled"
            shift
            ;;
        --run-all)
            RUN_ALL="true"
            print_info "Running all makers (2 standard + 2 taproot)"
            shift
            ;;
        *)
            # Store first extra argument for subcommands (e.g., service name, block count)
            if [[ -z "${SUBCOMMAND_ARG:-}" ]]; then
                SUBCOMMAND_ARG="$1"
            fi
            shift
            ;;
    esac
done

case "$COMMAND" in
    "setup")
        check_docker
        setup_coinswap_repo
        build_bitcoin_image
        build_image
        print_success "Setup complete! Run '$0 start' to start services"
        ;;
    "build")
        check_docker
        build_image
        ;;
    "build-bitcoin")
        check_docker
        build_bitcoin_image
        ;;
    "start")
        check_docker
        start_stack
        ;;
    "stop")
        stop_stack
        ;;
    "restart")
        stop_stack
        sleep 2
        start_stack
        ;;
    "fund-makers")
        fund_makers
        ;;
    "mine")
        mine_blocks "${SUBCOMMAND_ARG:-1}"
        ;;
    "start-mining")
        start_block_mining
        ;;
    "stop-mining")
        stop_block_mining
        ;;
    "logs")
        show_logs "${SUBCOMMAND_ARG:-}"
        ;;
    "status")
        cd "$SCRIPT_DIR"
        docker compose -f docker-compose.generated.yml ps 2>/dev/null || echo "No stack running"
        local pidfile="$SCRIPT_DIR/.block-mining.pid"
        if [ -f "$pidfile" ]; then
            local pid=$(cat "$pidfile")
            if ps -p "$pid" > /dev/null 2>&1; then
                echo "Block mining: RUNNING (PID: $pid)"
            else
                echo "Block mining: STOPPED"
            fi
        else
            echo "Block mining: STOPPED"
        fi
        ;;
    "help"|"--help"|"-h"|"")
        show_help
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        echo ""
        show_help
        exit 1
        ;;
esac